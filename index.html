let favorites=JSON.parse(localStorage.getItem("favorites")||"[]");
let historyList=JSON.parse(localStorage.getItem("history")||"[]");

// LOADING SKELETON
function loading(){container.innerHTML="";for(let i=0;i<6;i++)container.innerHTML+=`<div class="skeleton"></div>`}

// TRENDING
async function loadTrending(){
setActiveTab("Trending");
loading();
currentQuery="trending";
nextPageToken="";
const res=await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=trending&key=${API_KEY}`);
const data=await res.json();
container.innerHTML="";
data.items.forEach(v=>render({
id:v.id.videoId||v.id,
title:v.snippet.title,
thumb:v.snippet.thumbnails.high.url,
channel:v.snippet.channelTitle,
desc:v.snippet.description
}));
}

// CATEGORY
function category(name){setActiveTab(name);box.value=name;search();}

// SEARCH
async function search(reset=true){
setActiveTab("Search");
if(reset){container.innerHTML="";nextPageToken="";}
currentQuery=box.value;
loading();
let url=`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(currentQuery)}&key=${API_KEY}`;
url+=`&order=${document.getElementById("sort").value}`;
let upload=document.getElementById("upload").value;
if(upload==="today")url+="&publishedAfter="+new Date(Date.now()-86400000).toISOString();
if(upload==="week")url+="&publishedAfter="+new Date(Date.now()-604800000).toISOString();
if(upload==="month")url+="&publishedAfter="+new Date(Date.now()-2592000000).toISOString();
let duration=document.getElementById("duration").value;if(duration)url+=`&videoDuration=${duration}`;
if(nextPageToken)url+=`&pageToken=${nextPageToken}`;
const res=await fetch(url);const data=await res.json();
nextPageToken=data.nextPageToken||"";container.innerHTML="";
data.items.forEach(v=>render({
id:v.id.videoId,title:v.snippet.title,thumb:v.snippet.thumbnails.high.url,channel:v.snippet.channelTitle,desc:v.snippet.description
}));
}

box.addEventListener("keydown",e=>{if(e.key==="Enter")search();});

// LIVE TAB
async function loadLive(){
setActiveTab("Live");
loading();
const url=`https://www.googleapis.com/youtube/v3/search?part=snippet&eventType=live&type=video&maxResults=10&q=&key=${API_KEY}`;
const res=await fetch(url);
const data=await res.json();
container.innerHTML="";
data.items.forEach(v=>render({
id:v.id.videoId,title:v.snippet.title,thumb:v.snippet.thumbnails.high.url,channel:v.snippet.channelTitle,desc:v.snippet.description
}));
}

// RENDER
function render(v){
container.innerHTML+=`
<div class="video-card">
<div class="thumbnail" style="background-image:url('${v.thumb}')" onclick="playCenter('${v.id}','${v.title}','${v.channel}','${v.thumb}')"></div>
<div class="info">
<div class="title">${v.title}</div>
<div class="meta">${v.channel}</div>
<div class="desc">${v.desc?.slice(0,80)||""}...</div>
<button onclick='saveFavorite(${JSON.stringify(v)})'>‚≠ê</button>
<button onclick="share('${"https://youtube.com/watch?v="+v.id}')">üîó</button>
</div>
</div>`;
}

// CENTER PLAYER
function playCenter(id,title,channel,thumb){
document.getElementById("centerPlayer").style.display="flex";
document.getElementById("centerVideo").src=`https://www.youtube.com/embed/${id}?autoplay=1`;
historyList.unshift({id,title,channel,thumb});
localStorage.setItem("history",JSON.stringify(historyList));
}

// CLOSE CENTER
function closeCenter(e){
if(e.target.id==="centerPlayer" || e.target.id==="closeCenter"){
document.getElementById("centerPlayer").style.display="none";
document.getElementById("centerVideo").src="";
}
}

// FAVORITES
function saveFavorite(v){favorites.push(v);localStorage.setItem("favorites",JSON.stringify(favorites));alert("Added to favorites")}
function showFavorites(){container.innerHTML="";favorites.forEach(render);}
function clearFavorites(){favorites=[];localStorage.setItem("favorites","[]");alert("Favorites cleared")}

// HISTORY
function showHistory(){container.innerHTML="";historyList.forEach(render);}
function clearHistory(){historyList=[];localStorage.setItem("history","[]");alert("History cleared")}

// SHARE
function share(link){navigator.clipboard.writeText(link);alert("Link copied!");}

// THEME
function toggleTheme(){document.body.classList.toggle("theme-light");}

// VOICE
function voiceSearch(){if(!('webkitSpeechRecognition' in window)){alert("Not supported");return;}
let r=new webkitSpeechRecognition();r.lang="en-US";r.start();r.onresult=e=>{box.value=e.results[0][0].transcript;search();}}

// INFINITE SCROLL
window.addEventListener("scroll",()=>{if(window.innerHeight+window.scrollY>=document.body.offsetHeight-200){if(nextPageToken)search(false);}});

// TAB ACTIVE
function setActiveTab(name){document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));document.querySelectorAll(".tab").forEach(t=>{if(t.innerText===name)t.classList.add("active");});}

// LOAD TRENDING
loadTrending();
</script>

</body>
</html>
